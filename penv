#!/usr/bin/env bash
SCRIPT_PATH=$(realpath "$0")
SCRIPT_DIR=$(dirname "${SCRIPT_PATH}")
SCRIPT_NAME=$(basename ${SCRIPT_PATH})

# Version information
VERSION="0.1.2"

function usage()
{
    echo "Usage: ${SCRIPT_NAME} cmd [params]"
    echo ""
    echo "Python virtual environment management tool."
    echo ""
    echo "Commands:"
    echo "  create        Creates a new virtual environment."
    echo "                Usage: penv create <env_name> [description]"
    echo "  list          Lists all virtual environments."
    echo "                Usage: penv list [--sort-by=name|date]"
    echo "  remove        Removes a virtual environment."
    echo "                Usage: penv remove <env_name>"
    echo "  activate      Activates a virtual environment."
    echo "                Usage: penv activate <env_name>"
    echo "  show          Show active virtual environments."
    echo "                Usage: penv show"
    echo "  deactivate    Deactivates the current virtual environment."
    echo "                Usage: penv deactivate"
    echo "  clean         Deactivates all virtual environments."
    echo "                Usage: penv clean"
    echo "  clone         Clones a virtual environment to a new one."
    echo "                Usage: penv clone <source_env> <dest_env> [description]"
    echo "  requirements  Export/import requirements for an environment."
    echo "                Usage: penv requirements <env_name> <export|import> [file]"
    echo "  project       Bind projects to virtual environments."
    echo "                Usage: penv project <bind|unbind|show|list>"
    echo "  usage         Show disk usage of virtual environments."
    echo "                Usage: penv usage [--sort-by=size|name]"
    echo "  help, -h, --help    Displays this help message."
    echo "                Usage: penv help [command]"
    echo "  --version     Display version information."
    echo ""
    echo "Examples:"
    echo "  penv create myproject \"My Python project\""
    echo "  penv list"
    echo "  penv list --sort-by=date"
    echo "  penv activate myproject"
    echo "  penv deactivate"
    echo "  penv remove myproject"
    echo "  penv clone myproject newproject \"New project based on myproject\""
    echo "  penv requirements myproject export requirements.txt"
    echo "  penv requirements myproject import requirements.txt"
    echo "  penv project bind myproject"
    echo "  penv usage --sort-by=size"
    echo ""
    echo "For command-specific help, use: penv help <command>"
    exit 1
}

function version()
{
    echo "${SCRIPT_NAME} version ${VERSION}"
    exit 0
}

function command_help()
{
    if [ $# -eq 0 ]; then
        usage
        return
    fi

    local cmd=$1
    case "$cmd" in
        create)
            echo "Usage: penv create <env_name> [description]"
            echo ""
            echo "Creates a new Python virtual environment."
            echo ""
            echo "Arguments:"
            echo "  env_name      Name of the virtual environment to create"
            echo "  description   Optional description for the environment"
            echo ""
            echo "Example:"
            echo "  penv create myproject \"My Python project\""
            ;;
        list)
            echo "Usage: penv list [--sort-by=name|date] [--filter=pattern]"
            echo ""
            echo "Lists all Python virtual environments."
            echo ""
            echo "Options:"
            echo "  --sort-by=name|date   Sort environments by name (default) or creation date"
            echo "  --filter=pattern      Filter environments by name pattern"
            echo ""
            echo "Examples:"
            echo "  penv list"
            echo "  penv list --sort-by=date"
            echo "  penv list --filter=test"
            ;;
        remove)
            echo "Usage: penv remove <env_name>"
            echo ""
            echo "Removes a Python virtual environment."
            echo ""
            echo "Arguments:"
            echo "  env_name      Name of the virtual environment to remove"
            echo ""
            echo "Example:"
            echo "  penv remove myproject"
            ;;
        activate)
            echo "Usage: penv activate <env_name>"
            echo ""
            echo "Activates a Python virtual environment."
            echo ""
            echo "Arguments:"
            echo "  env_name      Name of the virtual environment to activate"
            echo ""
            echo "Example:"
            echo "  penv activate myproject"
            ;;
        show)
            echo "Usage: penv show"
            echo ""
            echo "Shows currently active virtual environments."
            echo ""
            echo "Example:"
            echo "  penv show"
            ;;
        deactivate)
            echo "Usage: penv deactivate"
            echo ""
            echo "Deactivates the currently active virtual environment."
            echo ""
            echo "Example:"
            echo "  penv deactivate"
            ;;
        clean)
            echo "Usage: penv clean"
            echo ""
            echo "Deactivates all active virtual environments."
            echo ""
            echo "Example:"
            echo "  penv clean"
            ;;
        clone)
            echo "Usage: penv clone <source_env_name> <dest_env_name> [description]"
            echo ""
            echo "Clones a Python virtual environment to a new one."
            echo ""
            echo "Arguments:"
            echo "  source_env_name    Name of the virtual environment to clone from"
            echo "  dest_env_name      Name of the new virtual environment to create"
            echo "  description        Optional description for the new environment"
            echo ""
            echo "Example:"
            echo "  penv clone myproject newproject \"New project based on myproject\""
            ;;
        requirements)
            echo "Usage: penv requirements <env_name> <export|import> [requirements_file]"
            echo ""
            echo "Export or import Python package requirements for a virtual environment."
            echo ""
            echo "Arguments:"
            echo "  env_name           Name of the virtual environment"
            echo "  operation          'export' to save packages to file, 'import' to install from file"
            echo "  requirements_file  Optional file path for requirements (default: environment's requirements.txt)"
            echo ""
            echo "Examples:"
            echo "  penv requirements myproject export requirements.txt"
            echo "  penv requirements myproject import requirements.txt"
            ;;
        project)
            echo "Usage: penv project <bind|unbind|show|list>"
            echo ""
            echo "Bind projects to virtual environments."
            echo ""
            echo "Operations:"
            echo "  bind   Bind current directory to a virtual environment"
            echo "         Usage: penv project bind <env_name>"
            echo "  unbind Unbind current directory from its virtual environment"
            echo "         Usage: penv project unbind"
            echo "  show   Show current directory binding"
            echo "         Usage: penv project show"
            echo "  list   List all project bindings"
            echo "         Usage: penv project list"
            echo ""
            echo "Examples:"
            echo "  penv project bind myproject"
            echo "  penv project show"
            echo "  penv project list"
            ;;
        usage)
            echo "Usage: penv usage [--sort-by=size|name]"
            echo ""
            echo "Show disk usage of virtual environments."
            echo ""
            echo "Options:"
            echo "  --sort-by=size|name   Sort environments by size (default) or name"
            echo ""
            echo "Example:"
            echo "  penv usage --sort-by=name"
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Use 'penv help' to see available commands."
            ;;
    esac
    exit 1
}

if [ $# -eq 0 ]
then
    usage
fi

cmd=$1
case "$cmd" in
    create|list|remove|activate|show|deactivate|clean|clone|requirements|project|usage)
        script_path="${SCRIPT_DIR}/scripts/${SCRIPT_NAME}-${cmd}.sh"
        if [[ -f "$script_path" && -r "$script_path" && -x "$script_path" ]]; then
            "$script_path" "${@:2}"
        else
            echo "Error: Command script '$script_path' not found or not executable." >&2
            exit 1
        fi
        ;;
    help|-h|--help)
        if [ $# -gt 1 ]; then
            command_help "${@:2}"
        else
            usage
        fi
        ;;
    --version)
        version
        ;;
    *)
        echo "The command '$cmd' is not supported."
        usage
        ;;
esac